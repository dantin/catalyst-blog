+++
date = "2016-07-07T11:28:56+08:00"
title = "分布式基础通信协议"
categories = ["Scholar"]
tags = ["Distributed System"]
description = "本文介绍分布式系统中的协议"
slug = "distributed-system-protocol"
+++

在分布式中，最难解决的一个问题就是多个节点间数据同步问题。为了解决这样的问题，涌现出了各种分布式通信协议。这里介绍几种：

### Paxos协议

说起Paxos是一种二段提交协议。简单来说，二阶段提交就是

1. 一个节点询问其他节点，我是不是可以进行消息提交。
2. 如果收到所有人的同意，则告诉大家，开始提交吧。

这个协议在实际中并不能很好的解决分布式中信息同步问题。例如只要有节点失效，就会发生得不到所有人同意的结果，在超时后，这一次提交失败，等一系列问题。但是Paxos在对二段提交进行了优化后，得到了一个比较好的解决办法。

Paxos协议引入了多数派，以及消息编号的概念。

* 第一步，询问2/n+1的参与者，要求他们保证不会接受小于编号n的提交。
* 第二步，如果得到了2/n+1的回复，则可以开始告诉2/n+1的参与者进行消息的提交。

这就是对二段提交的一个优化版。就是这么一个比较巧妙的思想，解决了一些二阶段提交带来的问题。

#### 第一阶段

proposer选择一个提案编号n并将prepare请求发送给acceptors中的一个多数派；
acceptor收到prepare消息后，如果提案的编号大于它已经回复的所有prepare消息，则acceptor将自己上次的批准回复给 proposer并承诺不再批准小于n的提案。

#### 第二阶段

当一个proposor收到了多数acceptors对prepare的回复后，就进入批准阶段。它要向回复prepare请求的acceptors发送accept请求，包括编号n和根据P2c决定的value（如果根据P2c没有决定value，那么它可以自由决定value）。在不违背自己向其他proposer的承诺的前提下，acceptor收到accept请求后即批准这个请求。

### Gossip协议

Gossip协议是一个神奇的协议。它常用于P2P的通信协议，这个协议就是模拟人类中传播谣言的行为而来。

简单的描述下这个协议：

> 首先要传播谣言就要有种子节点。种子节点每秒都会随机向其他节点发送自己所拥有的节点列表，以及需要传播的消息。任何新加入的节点，就在这种传播方式下很快地被全网所知道。这个协议的神奇就在于它从设计开始就没想到信息一定要传递给所有的节点，但是随着时间的增长，在最终的某一时刻，全网会得到相同的信息。当然这个时刻可能仅仅存在于理论，永远不可达。

gossip协议有多种实现，这里说一个例子当节点启动时，读配置文件，然后向一个seed发送信息，进行信息同步，然后开始每秒都随机选择一个seed节点来同步信息

1、随机取一个当前活着的节点，并向它发送同步请求
2、向随机一台不可达的机器发送同步请求
3、如果第一步中所选择的节点不是seed，或者当前活着的节点数少于seed数，则向随意一台seed发送同步请求

### 基础协议的对比

简单的介绍了这几种协议，下面我们来看看他们的对比：

| 基础协议 | paxos | gossip |
| ------- | ----- | ------ |
| 数据同步 | 见上  | 见上    |
| 数据一致性 | 强一致性 | 最终一致性 |
| 相关应用 | zookeeper | Cassandra |
| 优点 | 可以很好的解决通信一致性问题，在集群规模大 | 协议本身简单，组网规模几乎不受限制，通信性能好 |
| 缺点 | 理论性太强，如果要实际使用，还是需要进行优化 | 不能提供传统的数据一致性服务，在传输中占用较多的网络流量 |

参考

[CSDN](http://blog.csdn.net/cloudresearch/article/details/23127985)
[Paxos协议](http://en.wikipedia.org/wiki/Paxos_algorithm)
[Gossip协议](http://en.wikipedia.org/wiki/Gossip_protocol)
